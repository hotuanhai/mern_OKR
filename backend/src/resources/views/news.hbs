<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hiển thị Dữ liệu Metabase </title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid black;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: none;
    }
    .course-card {
      margin: 20px 0;
    }
    .course-card .card-body {
      padding: 15px;
    }
    .course-card .card-title {
      font-size: 1.25rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Metabase Data</h2>
  
  <iframe src="{{getIframeSrc oid}}" frameborder="0"></iframe>
  <!-- Metabase Iframe will be dynamically loaded here -->
  <div class="mt-4">
    <h3>Danh sách Kr</h3>
    <div class="row">
      {{#each courses}}
        <div class="col-sm-6 col-lg-4 mb-4">
          <div class="card course-card">
            <div class="card-body">
              <!-- Hiển thị ID của KR -->
              <a href="/kridcon/{{this.id}}">
                <h5 class="card-title">{{this.id}}</h5>
              </a>

              <!-- Hiển thị mô tả của KR -->
              <p class="card-text">{{this.description}}</p>
              <p class="card-text">{{this._id}}</p>

              <!-- Hiển thị thông tin khác -->
              <p class="card-text">Status: {{this.status}}</p>
              <p class="card-text">Progress: {{this.progress}}%</p>

              <!-- Button actions -->
                   <a href="#" class="btn btn-primary" onclick="showDetailInfo('{{this._id}}')">Go Detail</a>
              <a href="#" class="btn btn-success" onclick="sendCompletionEmail('{{this._id}}')">Gửi email</a>
            </div>
          </div>
        </div>
      {{/each}}
    </div>
  </div>
  
  <!-- Iframe for Metabase -->
  
  <!-- Modal để hiển thị chi tiết -->
  <div class="modal" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalLabel">Thông tin chi tiết</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="modal-body">
          <!-- Nội dung chi tiết sẽ được thêm vào đây -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // Gửi email khi hoàn thành công việc
    function showDetailInfo(krId) {
        fetch(`/api/get-kr-detail/${krId}`)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    const modalBody = document.getElementById('modal-body');
                    modalBody.innerHTML = `
                      <p><strong>ID:</strong> ${data.id}</p>
                        <p><strong>Description:</strong> ${data.description}</p>
                        <p><strong>Meta ID:</strong> ${data.MetaId}</p>
                        <p><strong>Picture:</strong> ${data.pic.join(', ')}</p>
                        <p><strong>Role:</strong> ${data.role}</p>
                        <p><strong>Proposer:</strong> ${data.proposer}</p>
                        <p><strong>Starting Value:</strong> ${data.startingValue}</p>
                        <p><strong>Target Value:</strong> ${data.targetValue}</p>
                        <p><strong>Current Value:</strong> ${data.currentValue}</p>
                        <p><strong>OKR State:</strong> ${data.okrState}</p>
                        <p><strong>Mandays:</strong> ${data.mandays}</p>
                        <p><strong>Progress:</strong> ${data.progress}%</p>
                        <p><strong>10th Month Real-time:</strong> ${data.thang10Realtime}%</p>
                        <p><strong>10th Month Actual:</strong> ${data.thang10Thucte}%</p>
                        <p><strong>Acceptance Criteria:</strong> ${data.acceptanceCriteria}</p>
                        <p><strong>Result:</strong> ${data.result}</p>
                        <p><strong>Proof:</strong> ${data.proof}</p>
                        <p><strong>Signoff Person (Email):</strong> ${data.signoffPerson}</p>
                        <p><strong>Signoff Status:</strong> ${data.signoff}</p>
                        <p><strong>Signoff Comment:</strong> ${data.signoffComment}</p>
                        <p><strong>Approval Status:</strong> ${data.approvalStatus === 'TRUE' ? 'Approved' : 'Not Approved'}</p>
                        <p><strong>Item Type:</strong> ${data.itemType}</p>
                        <p><strong>KR Type 1:</strong> ${data.krType1}</p>
                        <p><strong>KR Type 2:</strong> ${data.krType2}</p>
                        <p><strong>KR Type 3:</strong> ${data.krType3}</p>
                        <p><strong>Weight:</strong> ${data.weight !== null ? data.weight : 'Not Assigned'}</p>

                        <p><strong>Start Date:</strong> ${new Date(data.startDate).toLocaleDateString()}</p>
                        <p><strong>Due Date:</strong> ${new Date(data.dueDate).toLocaleDateString()}</p>
                        <p><strong>Done Date:</strong> ${data.doneDate ? new Date(data.doneDate).toLocaleDateString() : 'Not Done'}</p>
                    `;
                    $('#detailModal').modal('show');
                } else {
                    alert('Không tìm thấy thông tin chi tiết.');
                }
            })
            .catch(error => {
                console.error('Lỗi khi lấy dữ liệu chi tiết:', error);
                alert('Lỗi khi lấy dữ liệu. Vui lòng thử lại.');
            });
    }

    // Fetch dữ liệu từ Metabase (có thể không sử dụng trong trường hợp này)
    fetch('https://your-metabase-url.com/api/card/{card-id}/query/json', {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer your-session-token'
        }
    })
    .then(response => response.json())
    .then(data => {
        const tableBody = document.getElementById('data-table').getElementsByTagName('tbody')[0];
        data.forEach(row => {
            const tr = document.createElement('tr');
            const td1 = document.createElement('td');
            const td2 = document.createElement('td');
            td1.innerText = row['column1'];
            td2.innerText = row['column2'];
            tr.appendChild(td1);
            tr.appendChild(td2);
            tableBody.appendChild(tr);
        });
    })
    .catch(error => console.error('Error fetching Metabase data:', error));



    function sendCompletionEmail(krId) {
      if (!confirm('Bạn có chắc chắn muốn gửi email thông báo hoàn thành công việc này không?')) {
        return;
      }

      fetch(`/api/send-email/${krId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          alert('Đã gửi email thành công!');
        } else if (data.error) {
          alert('Gửi email thất bại: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Lỗi khi gửi email:', error);
        alert('Gửi email thất bại. Vui lòng thử lại.');
      });
    }
  </script>
</body>
</html>
